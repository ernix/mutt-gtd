#!/bin/bash

#
# https://github.com/stockc/mutt-gtd
#
# $1 is the tag to be toggled (e.g. review, todo, waiting, urgent)
# $2 is the filename provided by mutt

label="$1"
mbox="$2"
X_LABEL="X-Label"

tmpfile=
trap "rm -f $tmpfile 2>/dev/null" 1 2 3 15
tmpfile=`mktemp 2>/dev/null || mktemp -t tmp`

ex_label=`formail -czx "$X_LABEL" < "$mbox"`

new_label=`echo "$ex_label" | perl -snle '
	next if m/\A\z/xms;
	++$del && next if m/\A\Q$l\E\z/xms;
	print $_;
	END { print "$l\n" unless $del; }
' -- -l="$label"`

fm_arg=`echo "$new_label" \
	| awk -v x_label="${X_LABEL}:" '{ print x_label, $0 }' \
	| sed 's/[ \t]*$//'`

formail -I "$fm_arg" < "$mbox" > "$tmpfile" || exit 1
mv "$tmpfile" "$mbox" 2>/dev/null
